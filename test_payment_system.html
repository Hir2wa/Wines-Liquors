<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Test Payment System - Wines & Liquors</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: #f8f9fa;
        margin: 0;
        padding: 20px;
      }

      .container {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #dc3545, #c82333);
        color: white;
        padding: 30px;
        text-align: center;
      }

      .header h1 {
        margin: 0;
        font-size: 28px;
      }

      .header p {
        margin: 10px 0 0;
        opacity: 0.9;
      }

      .content {
        padding: 30px;
      }

      .test-section {
        margin-bottom: 30px;
        padding: 20px;
        border: 1px solid #e9ecef;
        border-radius: 8px;
      }

      .test-section h3 {
        margin: 0 0 15px;
        color: #2c3e50;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .test-section h3 i {
        color: #dc3545;
      }

      .form-group {
        margin-bottom: 15px;
      }

      .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        color: #495057;
      }

      .form-group input,
      .form-group select {
        width: 100%;
        padding: 10px;
        border: 1px solid #ced4da;
        border-radius: 6px;
        font-size: 14px;
      }

      .form-group input:focus,
      .form-group select:focus {
        outline: none;
        border-color: #dc3545;
        box-shadow: 0 0 0 2px rgba(220, 53, 69, 0.25);
      }

      .btn {
        background: #dc3545;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .btn:hover {
        background: #c82333;
      }

      .btn:disabled {
        background: #6c757d;
        cursor: not-allowed;
      }

      .btn-secondary {
        background: #6c757d;
      }

      .btn-secondary:hover {
        background: #5a6268;
      }

      .result {
        margin-top: 15px;
        padding: 15px;
        border-radius: 6px;
        font-family: monospace;
        font-size: 12px;
        white-space: pre-wrap;
        max-height: 300px;
        overflow-y: auto;
      }

      .result.success {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
      }

      .result.error {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
      }

      .result.info {
        background: #d1ecf1;
        border: 1px solid #bee5eb;
        color: #0c5460;
      }

      .payment-instructions {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
      }

      .payment-code {
        background: #e9ecef;
        padding: 8px 12px;
        border-radius: 4px;
        font-family: monospace;
        font-weight: bold;
        color: #dc3545;
        font-size: 18px;
        display: inline-block;
        margin: 5px 0;
      }

      .status-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
      }

      .status-pending {
        background: #fff3cd;
        color: #856404;
      }

      .status-approved {
        background: #d4edda;
        color: #155724;
      }

      .status-rejected {
        background: #f8d7da;
        color: #721c24;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1><i class="fas fa-credit-card"></i> Payment System Test</h1>
        <p>Test the mobile money payment system with verification codes</p>
      </div>

      <div class="content">
        <!-- Test 1: Create Order with Mobile Money Payment -->
        <div class="test-section">
          <h3>
            <i class="fas fa-shopping-cart"></i> Test 1: Create Order with
            Mobile Money Payment
          </h3>
          <p>
            Create a test order with mobile money payment to generate a payment
            code.
          </p>

          <div class="form-group">
            <label>Customer Email:</label>
            <input
              type="email"
              id="customerEmail"
              value="test@example.com"
              placeholder="Enter customer email"
            />
          </div>

          <div class="form-group">
            <label>Customer Phone:</label>
            <input
              type="tel"
              id="customerPhone"
              value="+250788123456"
              placeholder="Enter phone number"
            />
          </div>

          <div class="form-group">
            <label>Customer Name:</label>
            <input
              type="text"
              id="customerName"
              value="John Doe"
              placeholder="Enter customer name"
            />
          </div>

          <div class="form-group">
            <label>Order Amount:</label>
            <input
              type="number"
              id="orderAmount"
              value="50000"
              placeholder="Enter order amount"
            />
          </div>

          <button class="btn" onclick="createTestOrder()">
            <i class="fas fa-plus"></i> Create Test Order
          </button>

          <div id="orderResult" class="result" style="display: none"></div>
          <div
            id="paymentInstructions"
            class="payment-instructions"
            style="display: none"
          ></div>
        </div>

        <!-- Test 2: Admin Payment Verification -->
        <div class="test-section">
          <h3>
            <i class="fas fa-user-shield"></i> Test 2: Admin Payment
            Verification
          </h3>
          <p>Simulate admin verifying a mobile money payment.</p>

          <div class="form-group">
            <label>Order ID:</label>
            <input
              type="text"
              id="verifyOrderId"
              placeholder="Enter order ID from Test 1"
            />
          </div>

          <div class="form-group">
            <label>Payment Code:</label>
            <input
              type="text"
              id="verifyPaymentCode"
              placeholder="Enter payment code from Test 1"
            />
          </div>

          <div class="form-group">
            <label>Admin Name:</label>
            <input
              type="text"
              id="adminName"
              value="Admin User"
              placeholder="Enter admin name"
            />
          </div>

          <button class="btn" onclick="verifyPayment()">
            <i class="fas fa-check"></i> Verify Payment
          </button>

          <div id="verifyResult" class="result" style="display: none"></div>
        </div>

        <!-- Test 3: Get Pending Payments -->
        <div class="test-section">
          <h3><i class="fas fa-list"></i> Test 3: Get Pending Payments</h3>
          <p>Retrieve all pending mobile money payments for admin review.</p>

          <button class="btn" onclick="getPendingPayments()">
            <i class="fas fa-sync"></i> Get Pending Payments
          </button>

          <div id="pendingResult" class="result" style="display: none"></div>
        </div>

        <!-- Test 4: Get Payment Code for Order -->
        <div class="test-section">
          <h3>
            <i class="fas fa-search"></i> Test 4: Get Payment Code for Order
          </h3>
          <p>Retrieve payment code details for a specific order.</p>

          <div class="form-group">
            <label>Order ID:</label>
            <input
              type="text"
              id="getCodeOrderId"
              placeholder="Enter order ID"
            />
          </div>

          <button class="btn" onclick="getPaymentCode()">
            <i class="fas fa-search"></i> Get Payment Code
          </button>

          <div id="codeResult" class="result" style="display: none"></div>
        </div>
      </div>
    </div>

    <script>
      let currentOrderId = null;
      let currentPaymentCode = null;

      // Test 1: Create Order with Mobile Money Payment
      async function createTestOrder() {
        const email = document.getElementById("customerEmail").value;
        const phone = document.getElementById("customerPhone").value;
        const name = document.getElementById("customerName").value;
        const amount = parseFloat(document.getElementById("orderAmount").value);

        if (!email || !phone || !name || !amount) {
          showResult("orderResult", "Please fill in all fields", "error");
          return;
        }

        const orderData = {
          customerInfo: {
            email: email,
            phone: phone,
            firstName: name.split(" ")[0],
            lastName: name.split(" ")[1] || "",
            address: "Test Address",
            city: "Kigali",
            country: "Rwanda",
          },
          items: [
            {
              name: "Test Wine Bottle",
              price: amount,
              quantity: 1,
              image: "images/WINE1.webp",
            },
          ],
          paymentMethod: "mobile_money",
          total: amount,
        };

        try {
          showResult("orderResult", "Creating order...", "info");

          const response = await fetch("/create_order.php", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(orderData),
          });

          const result = await response.json();

          if (response.ok) {
            currentOrderId = result.data.orderId;
            currentPaymentCode = result.data.paymentCode;

            showResult(
              "orderResult",
              JSON.stringify(result, null, 2),
              "success"
            );
            showPaymentInstructions(result.data);

            // Auto-fill verification fields
            document.getElementById("verifyOrderId").value = currentOrderId;
            document.getElementById("verifyPaymentCode").value =
              currentPaymentCode.payment_code;
            document.getElementById("getCodeOrderId").value = currentOrderId;
          } else {
            showResult("orderResult", `Error: ${result.message}`, "error");
          }
        } catch (error) {
          showResult("orderResult", `Network Error: ${error.message}`, "error");
        }
      }

      // Show payment instructions
      function showPaymentInstructions(orderData) {
        const instructions = document.getElementById("paymentInstructions");
        const paymentCode = orderData.paymentCode;

        instructions.innerHTML = `
                <h4><i class="fas fa-mobile-alt"></i> Mobile Money Payment Instructions</h4>
                <p><strong>Order ID:</strong> ${orderData.orderId}</p>
                <p><strong>Amount:</strong> ${paymentCode.amount}frw</p>
                <p><strong>Payment Code:</strong> <span class="payment-code">${
                  paymentCode.payment_code
                }</span></p>
                <p><strong>Instructions:</strong> ${
                  paymentCode.instructions
                }</p>
                <p><strong>Expires:</strong> ${new Date(
                  paymentCode.expires_at
                ).toLocaleString()}</p>
                <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 6px; padding: 12px; margin-top: 15px;">
                    <i class="fas fa-info-circle" style="color: #856404; margin-right: 8px;"></i>
                    <span style="color: #856404;">This payment code will be verified by the admin team once payment is received.</span>
                </div>
            `;
        instructions.style.display = "block";
      }

      // Test 2: Admin Payment Verification
      async function verifyPayment() {
        const orderId = document.getElementById("verifyOrderId").value;
        const paymentCode = document.getElementById("verifyPaymentCode").value;
        const adminName = document.getElementById("adminName").value;

        if (!orderId || !paymentCode || !adminName) {
          showResult("verifyResult", "Please fill in all fields", "error");
          return;
        }

        try {
          showResult("verifyResult", "Verifying payment...", "info");

          const response = await fetch("/api/admin/verify-payment-code", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              orderId: orderId,
              paymentCode: paymentCode,
              verifiedBy: adminName,
            }),
          });

          const result = await response.json();

          if (response.ok) {
            showResult(
              "verifyResult",
              JSON.stringify(result, null, 2),
              "success"
            );
          } else {
            showResult("verifyResult", `Error: ${result.message}`, "error");
          }
        } catch (error) {
          showResult(
            "verifyResult",
            `Network Error: ${error.message}`,
            "error"
          );
        }
      }

      // Test 3: Get Pending Payments
      async function getPendingPayments() {
        try {
          showResult("pendingResult", "Fetching pending payments...", "info");

          const response = await fetch("/api/admin/pending-payments");
          const result = await response.json();

          if (response.ok) {
            showResult(
              "pendingResult",
              JSON.stringify(result, null, 2),
              "success"
            );
          } else {
            showResult("pendingResult", `Error: ${result.message}`, "error");
          }
        } catch (error) {
          showResult(
            "pendingResult",
            `Network Error: ${error.message}`,
            "error"
          );
        }
      }

      // Test 4: Get Payment Code for Order
      async function getPaymentCode() {
        const orderId = document.getElementById("getCodeOrderId").value;

        if (!orderId) {
          showResult("codeResult", "Please enter an order ID", "error");
          return;
        }

        try {
          showResult("codeResult", "Fetching payment code...", "info");

          const response = await fetch(
            `/test_payment_code.php?orderId=${orderId}`
          );
          const result = await response.json();

          if (response.ok) {
            showResult(
              "codeResult",
              JSON.stringify(result, null, 2),
              "success"
            );
          } else {
            showResult("codeResult", `Error: ${result.message}`, "error");
          }
        } catch (error) {
          showResult("codeResult", `Network Error: ${error.message}`, "error");
        }
      }

      // Helper function to show results
      function showResult(elementId, message, type) {
        const element = document.getElementById(elementId);
        element.textContent = message;
        element.className = `result ${type}`;
        element.style.display = "block";
      }

      // Initialize page
      document.addEventListener("DOMContentLoaded", function () {
        console.log("Payment System Test Page Loaded");
        console.log("Available tests:");
        console.log("1. Create Order with Mobile Money Payment");
        console.log("2. Admin Payment Verification");
        console.log("3. Get Pending Payments");
        console.log("4. Get Payment Code for Order");
      });
    </script>
  </body>
</html>
