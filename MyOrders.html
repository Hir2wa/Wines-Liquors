<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Order Management - Total Wine & More</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="Header.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <style>
      .my-orders-container {
        min-height: 100vh;
        background: #f8f9fa;
      }

      .my-orders-header {
        background: white;
        border-bottom: 1px solid #e9ecef;
        padding: 20px 0;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .header-content {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .back-link {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        background: #f8f9fa;
        border: 1px solid #dc3545;
        border-radius: 6px;
        color: #dc3545;
        text-decoration: none;
        font-weight: 500;
        transition: all 0.3s ease;
      }

      .back-link:hover {
        background: #dc3545;
        color: white;
      }

      .logo img {
        height: 40px;
      }

      .header-actions {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .cart-btn {
        position: relative;
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        background: white;
        color: #495057;
        text-decoration: none;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        font-weight: 500;
        transition: all 0.3s ease;
      }

      .cart-btn:hover {
        background: #f8f9fa;
        color: #495057;
        border-color: #adb5bd;
      }

      .cart-count {
        background: #ffc107;
        color: #212529;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: bold;
      }

      .my-orders-section {
        max-width: 1200px;
        margin: 0 auto;
        padding: 40px 20px;
      }

      .section-header {
        text-align: center;
        margin-bottom: 40px;
      }

      .section-header h1 {
        font-size: 2.5rem;
        color: #212529;
        margin-bottom: 10px;
        font-weight: 700;
      }

      .section-header p {
        font-size: 1.1rem;
        color: #6c757d;
        margin: 0;
      }

      .order-tabs {
        display: flex;
        justify-content: center;
        margin-bottom: 30px;
        background: white;
        border-radius: 12px;
        padding: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        max-width: 600px;
        margin-left: auto;
        margin-right: auto;
      }

      .tab-button {
        flex: 1;
        padding: 12px 24px;
        background: transparent;
        border: none;
        border-radius: 8px;
        font-weight: 500;
        color: #6c757d;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }

      .tab-button.active {
        background: #dc3545;
        color: white;
        box-shadow: 0 2px 4px rgba(220, 53, 69, 0.3);
      }

      .tab-button:hover:not(.active) {
        background: #f8f9fa;
        color: #495057;
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      .order-search {
        background: white;
        border-radius: 12px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .search-form {
        display: flex;
        gap: 15px;
        max-width: 500px;
        margin: 0 auto;
      }

      .search-input {
        flex: 1;
        padding: 12px 16px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        font-size: 16px;
        transition: border-color 0.3s ease;
      }

      .search-input:focus {
        outline: none;
        border-color: #dc3545;
      }

      .search-btn {
        padding: 12px 24px;
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 500;
        cursor: pointer;
        transition: background 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .search-btn:hover {
        background: #c82333;
      }

      .orders-list {
        display: grid;
        gap: 20px;
      }

      .order-card {
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
      }

      .order-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
      }

      .order-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #e9ecef;
      }

      .order-info h3 {
        font-size: 1.25rem;
        color: #212529;
        margin: 0 0 5px 0;
        font-weight: 600;
      }

      .order-date {
        color: #6c757d;
        font-size: 0.9rem;
        margin: 0;
      }

      .order-status {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 5px;
      }

      .status-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .status-badge.pending {
        background: #fff3cd;
        color: #856404;
      }

      .status-badge.processing {
        background: #d1ecf1;
        color: #0c5460;
      }

      .status-badge.shipped {
        background: #cce5ff;
        color: #004085;
      }

      .status-badge.completed {
        background: #d4edda;
        color: #155724;
      }

      .status-badge.cancelled {
        background: #f8d7da;
        color: #721c24;
      }

      .payment-status {
        font-size: 0.75rem;
        color: #6c757d;
        font-weight: 500;
      }

      .order-items-preview {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }

      .item-preview {
        display: flex;
        align-items: center;
        gap: 10px;
        background: #f8f9fa;
        padding: 10px;
        border-radius: 8px;
        flex: 1;
        min-width: 200px;
      }

      .item-preview img {
        width: 40px;
        height: 40px;
        object-fit: cover;
        border-radius: 4px;
      }

      .item-info h4 {
        font-size: 0.9rem;
        color: #212529;
        margin: 0 0 2px 0;
        font-weight: 500;
      }

      .item-info p {
        font-size: 0.8rem;
        color: #6c757d;
        margin: 0;
      }

      .more-items {
        display: flex;
        align-items: center;
        justify-content: center;
        background: #e9ecef;
        padding: 10px;
        border-radius: 8px;
        color: #6c757d;
        font-size: 0.8rem;
        font-weight: 500;
      }

      .order-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 15px;
      }

      .order-total {
        font-size: 1.1rem;
        font-weight: 600;
        color: #dc3545;
      }

      .order-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 6px;
        font-size: 0.85rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 6px;
        text-decoration: none;
      }

      .btn-primary {
        background: #dc3545;
        color: white;
      }

      .btn-primary:hover {
        background: #c82333;
        color: white;
      }

      .btn-secondary {
        background: #6c757d;
        color: white;
      }

      .btn-secondary:hover {
        background: #5a6268;
        color: white;
      }

      .btn-success {
        background: #28a745;
        color: white;
      }

      .btn-success:hover {
        background: #218838;
        color: white;
      }

      .btn-warning {
        background: #ffc107;
        color: #212529;
      }

      .btn-warning:hover {
        background: #e0a800;
        color: #212529;
      }

      .btn-danger {
        background: #dc3545;
        color: white;
      }

      .btn-danger:hover {
        background: #c82333;
        color: white;
      }

      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #6c757d;
      }

      .empty-state i {
        font-size: 4rem;
        margin-bottom: 20px;
        opacity: 0.3;
      }

      .empty-state h3 {
        font-size: 1.5rem;
        margin-bottom: 10px;
        color: #495057;
      }

      .empty-state p {
        font-size: 1rem;
        margin-bottom: 20px;
      }

      .loading-state {
        text-align: center;
        padding: 60px 20px;
        color: #6c757d;
      }

      .loading-state i {
        font-size: 3rem;
        margin-bottom: 20px;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .error-state {
        text-align: center;
        padding: 60px 20px;
        color: #dc3545;
      }

      .error-state i {
        font-size: 4rem;
        margin-bottom: 20px;
      }

      .error-state h3 {
        font-size: 1.5rem;
        margin-bottom: 10px;
      }

      .error-state p {
        font-size: 1rem;
        margin-bottom: 20px;
        color: #6c757d;
      }

      /* Order Creation Form Styles */
      .order-creation-form {
        background: white;
        border-radius: 12px;
        padding: 30px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        max-width: 800px;
        margin: 0 auto;
      }

      .form-container h3 {
        color: #212529;
        margin-bottom: 30px;
        font-size: 1.5rem;
        font-weight: 600;
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #495057;
      }

      .form-group input {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        font-size: 16px;
        transition: border-color 0.3s ease;
      }

      .form-group input:focus {
        outline: none;
        border-color: #dc3545;
      }

      .payment-methods {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
      }

      .payment-option {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        padding: 10px 15px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        transition: all 0.3s ease;
      }

      .payment-option:hover {
        border-color: #dc3545;
        background: #f8f9fa;
      }

      .payment-option input[type="radio"] {
        margin: 0;
        width: auto;
      }

      .payment-option input[type="radio"]:checked + span {
        color: #dc3545;
        font-weight: 600;
      }

      .order-summary {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin: 30px 0;
      }

      .order-summary h4 {
        color: #212529;
        margin-bottom: 15px;
        font-size: 1.2rem;
      }

      .order-total {
        text-align: right;
        font-size: 1.2rem;
        color: #dc3545;
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid #dee2e6;
      }

      .cart-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid #dee2e6;
      }

      .cart-item:last-child {
        border-bottom: none;
      }

      .item-info {
        display: flex;
        align-items: center;
        gap: 10px;
        flex: 1;
      }

      .item-details h5 {
        margin: 0;
        font-size: 0.9rem;
        color: #212529;
      }

      .item-details p {
        margin: 0;
        font-size: 0.8rem;
        color: #6c757d;
      }

      .quantity-controls {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .qty-btn {
        width: 28px;
        height: 28px;
        border: 1px solid #dc3545;
        background: white;
        color: #dc3545;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        transition: all 0.3s ease;
      }

      .qty-btn:hover {
        background: #dc3545;
        color: white;
      }

      .qty-display {
        min-width: 25px;
        text-align: center;
        font-weight: 600;
        color: #333;
        font-size: 0.9rem;
      }

      .remove-btn {
        width: 28px;
        height: 28px;
        border: 1px solid #dc3545;
        background: #dc3545;
        color: white;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        transition: all 0.3s ease;
        margin-left: 5px;
      }

      .remove-btn:hover {
        background: #c82333;
        border-color: #c82333;
      }

      @media (max-width: 768px) {
        .header-content {
          flex-direction: column;
          gap: 15px;
        }

        .order-tabs {
          flex-direction: column;
        }

        .search-form {
          flex-direction: column;
        }

        .order-header {
          flex-direction: column;
          gap: 15px;
        }

        .order-status {
          align-items: flex-start;
        }

        .order-footer {
          flex-direction: column;
          align-items: stretch;
        }

        .order-actions {
          justify-content: center;
        }

        .item-preview {
          min-width: auto;
        }

        /* Mobile Responsive for Order Management Section */
        .section-header {
          text-align: center;
          padding: 20px 15px;
          margin-bottom: 25px;
        }

        .section-header h1 {
          font-size: 1.8rem;
          margin-bottom: 8px;
          line-height: 1.2;
        }

        .section-header p {
          font-size: 0.9rem;
          line-height: 1.4;
          max-width: 100%;
        }

        .order-tabs {
          flex-direction: column;
          gap: 8px;
          padding: 15px;
          margin: 0 15px 25px 15px;
          max-width: none;
        }

        .tab-button {
          padding: 15px 20px;
          font-size: 16px;
          min-height: 50px;
        }

        /* Header Mobile Improvements */
        .header-content {
          flex-direction: column;
          gap: 15px;
          padding: 0 15px;
        }

        .back-link {
          align-self: flex-start;
          padding: 10px 15px;
          font-size: 14px;
        }

        .logo img {
          height: 35px;
        }

        .header-actions {
          width: 100%;
          justify-content: center;
        }

        .cart-btn {
          padding: 10px 15px;
          font-size: 14px;
        }
      }
    </style>
  </head>
  <body>
    <div class="my-orders-container">
      <!-- Header -->
      <header class="my-orders-header">
        <div class="header-content">
          <a href="index.html" class="back-link">
            <i class="fas fa-arrow-left"></i>
            Back to Home
          </a>
          <div class="logo">
            <img
              src="images/logo1.png"
              alt="Total Wine & More Logo"
              style="width: 150px"
            />
          </div>
          <div class="header-actions">
            <a href="MyOrders.html" class="cart-btn">
              <i class="fas fa-shopping-cart"></i>
              <span class="cart-count">0</span>
            </a>
          </div>
        </div>
      </header>

      <!-- My Orders Section -->
      <section class="my-orders-section">
        <div class="section-header">
          <h1>Order Management</h1>
          <p>Create, track, and manage all your orders in one place</p>
        </div>

        <!-- Order Tabs -->
        <div class="order-tabs">
          <button class="tab-button active" onclick="switchTab('create')">
            <i class="fas fa-plus"></i>
            Create Order
          </button>
          <button class="tab-button" onclick="switchTab('all')">
            <i class="fas fa-list"></i>
            All Orders
          </button>
          <button class="tab-button" onclick="switchTab('track')">
            <i class="fas fa-search"></i>
            Track Order
          </button>
        </div>

        <!-- Create Order Tab -->
        <div id="create-order-tab" class="tab-content active">
          <div class="order-creation-form">
            <div class="form-container">
              <h3>Create New Order</h3>
              <form id="orderForm">
                <div class="form-row">
                  <div class="form-group">
                    <label for="firstName">First Name *</label>
                    <input
                      type="text"
                      id="firstName"
                      name="firstName"
                      required
                    />
                  </div>
                  <div class="form-group">
                    <label for="lastName">Last Name *</label>
                    <input type="text" id="lastName" name="lastName" required />
                  </div>
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label for="email">Email *</label>
                    <input type="email" id="email" name="email" required />
                  </div>
                  <div class="form-group">
                    <label for="phone">Phone *</label>
                    <input type="tel" id="phone" name="phone" required />
                  </div>
                </div>

                <div class="form-group">
                  <label for="address">Address *</label>
                  <input type="text" id="address" name="address" required />
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label for="city">City *</label>
                    <input type="text" id="city" name="city" required />
                  </div>
                  <div class="form-group">
                    <label for="country">Country *</label>
                    <input type="text" id="country" name="country" required />
                  </div>
                </div>

                <div class="form-group">
                  <label>Payment Method *</label>
                  <div class="payment-methods">
                    <label class="payment-option">
                      <input
                        type="radio"
                        name="paymentMethod"
                        value="mobile_money"
                        required
                      />
                      <span>Mobile Money</span>
                    </label>
                    <label class="payment-option">
                      <input
                        type="radio"
                        name="paymentMethod"
                        value="momo_code"
                        required
                      />
                      <span>Momo Code</span>
                    </label>
                    <label class="payment-option">
                      <input
                        type="radio"
                        name="paymentMethod"
                        value="cash_on_delivery"
                        required
                      />
                      <span>Cash on Delivery</span>
                    </label>
                  </div>

                  <!-- Momo Code Input Field -->
                  <div
                    class="form-group"
                    id="momoCodeGroup"
                    style="display: none"
                  >
                    <label for="momoCode">Momo Code *</label>
                    <input
                      type="text"
                      id="momoCode"
                      name="momoCode"
                      value="*182*8*1*258655#"
                      readonly
                    />
                  </div>
                </div>

                <div class="order-summary">
                  <h4>Order Summary</h4>
                  <div id="cartItemsDisplay"></div>
                  <div class="order-total">
                    <strong>Total: <span id="orderTotal">0frw</span></strong>
                  </div>
                </div>

                <button
                  type="submit"
                  class="btn btn-primary"
                  id="createOrderBtn"
                >
                  <i class="fas fa-lock"></i> Create Order
                </button>
              </form>
            </div>
          </div>
        </div>

        <!-- All Orders Tab -->
        <div id="all-orders-tab" class="tab-content">
          <div class="orders-list" id="ordersList">
            <!-- Orders will be loaded here -->
          </div>
        </div>

        <!-- Track Order Tab -->
        <div id="track-order-tab" class="tab-content">
          <div class="order-search">
            <div class="search-form">
              <input
                type="text"
                id="orderNumber"
                class="search-input"
                placeholder="Enter your order number (e.g., ORD-123456789)"
                maxlength="20"
              />
              <button class="search-btn" onclick="trackOrder()">
                <i class="fas fa-search"></i>
                Track Order
              </button>
            </div>
          </div>

          <div id="trackingResults">
            <!-- Tracking results will be shown here -->
          </div>
        </div>
      </section>
    </div>

    <script src="js/api-client.js"></script>
    <script>
      // Check if user is logged in
      function checkLoginStatus() {
        const isLoggedIn = localStorage.getItem("user_logged_in") === "true";
        const userData = localStorage.getItem("userData");

        if (!isLoggedIn || !userData) {
          showLoginPrompt();
          return false;
        }
        return true;
      }

      // Show login prompt
      function showLoginPrompt() {
        const ordersList = document.getElementById("ordersList");
        ordersList.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-user-lock"></i>
            <h3>Please Sign In</h3>
            <p>You need to be signed in to view your orders.</p>
            <div style="margin-top: 20px;">
              <a href="login.html" class="btn btn-primary" style="margin-right: 10px; text-decoration: none;">
                <i class="fas fa-sign-in-alt"></i> Sign In
              </a>
              <a href="Register.html" class="btn btn-secondary" style="text-decoration: none;">
                <i class="fas fa-user-plus"></i> Create Account
              </a>
            </div>
          </div>
        `;
      }

      // Switch between tabs
      function switchTab(tabName) {
        // Update tab buttons
        document.querySelectorAll(".tab-button").forEach((btn) => {
          btn.classList.remove("active");
        });
        event.target.classList.add("active");

        // Update tab content
        document.querySelectorAll(".tab-content").forEach((content) => {
          content.classList.remove("active");
        });

        if (tabName === "create") {
          document.getElementById("create-order-tab").classList.add("active");
          loadCartItems();
        } else if (tabName === "all") {
          document.getElementById("all-orders-tab").classList.add("active");
          loadOrderHistory();
        } else if (tabName === "track") {
          document.getElementById("track-order-tab").classList.add("active");
        }
      }

      // Load order history
      async function loadOrderHistory() {
        if (!checkLoginStatus()) {
          return;
        }

        const ordersList = document.getElementById("ordersList");
        ordersList.innerHTML = `
          <div class="loading-state">
            <i class="fas fa-spinner"></i>
            <h3>Loading Orders...</h3>
            <p>Please wait while we fetch your order history.</p>
          </div>
        `;

        try {
          const sessionToken = localStorage.getItem("sessionToken");

          const response = await fetch(
            "http://localhost:8000/api/orders/customer",
            {
              method: "GET",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${sessionToken}`,
              },
            }
          );

          if (response.ok) {
            const result = await response.json();
            const orders = result.data.orders;

            if (orders.length === 0) {
              ordersList.innerHTML = `
                <div class="empty-state">
                  <i class="fas fa-shopping-cart"></i>
                  <h3>No Orders Yet</h3>
                  <p>You haven't placed any orders yet. Start shopping to see your order history here.</p>
                  <a href="index.html" class="btn btn-primary" style="margin-top: 20px; display: inline-block; text-decoration: none;">
                    <i class="fas fa-shopping-bag"></i> Start Shopping
                  </a>
                </div>
              `;
              return;
            }

            ordersList.innerHTML = "";
            orders.forEach((order) => {
              const orderCard = createOrderCard(order);
              ordersList.appendChild(orderCard);
            });
          } else if (response.status === 401) {
            showLoginPrompt();
          } else {
            throw new Error("Failed to load orders");
          }
        } catch (error) {
          console.error("Failed to load order history:", error);
          ordersList.innerHTML = `
            <div class="error-state">
              <i class="fas fa-exclamation-triangle"></i>
              <h3>Error Loading Orders</h3>
              <p>Failed to load your order history. Please try again later.</p>
              <button onclick="loadOrderHistory()" class="btn btn-primary" style="margin-top: 20px;">
                <i class="fas fa-refresh"></i> Try Again
              </button>
            </div>
          `;
        }
      }

      // Create order card
      function createOrderCard(order) {
        const orderCard = document.createElement("div");
        orderCard.className = "order-card";
        orderCard.setAttribute("data-status", order.status);

        const itemsPreview = order.items
          .slice(0, 2)
          .map(
            (item) => `
          <div class="item-preview">
            <img src="${item.image || "images/WINE1.webp"}" alt="${
              item.name
            }" />
            <div class="item-info">
              <h4>${item.name}</h4>
              <p>Qty: ${item.quantity || 1}</p>
            </div>
          </div>
        `
          )
          .join("");

        const moreItems =
          order.items.length > 2
            ? `<div class="more-items"><span>+${
                order.items.length - 2
              } more item${order.items.length - 2 > 1 ? "s" : ""}</span></div>`
            : "";

        const actions = getOrderActions(order);

        orderCard.innerHTML = `
          <div class="order-header">
            <div class="order-info">
              <h3>Order #${order.orderId}</h3>
              <p class="order-date">${new Date(
                order.date
              ).toLocaleDateString()}</p>
            </div>
            <div class="order-status">
              <span class="status-badge ${order.status}">${
          order.status.charAt(0).toUpperCase() + order.status.slice(1)
        }</span>
              <span class="payment-status">Payment: ${
                order.paymentStatus
              }</span>
            </div>
          </div>
          
          <div class="order-items-preview">
            ${itemsPreview}
            ${moreItems}
          </div>

          <div class="order-footer">
            <div class="order-total">
              <span>Total: ${order.total}</span>
            </div>
            <div class="order-actions">
              ${actions}
            </div>
          </div>
        `;

        return orderCard;
      }

      // Get order actions based on status
      function getOrderActions(order) {
        let actions = `
          <button class="btn btn-secondary" onclick="viewOrderDetails('${order.orderId}')">
            <i class="fas fa-eye"></i>
            View Details
          </button>
        `;

        if (order.status === "completed") {
          actions += `
            <button class="btn btn-success" onclick="reorder('${order.orderId}')">
              <i class="fas fa-redo"></i>
              Reorder
            </button>
            <button class="btn btn-warning" onclick="writeReview('${order.orderId}')">
              <i class="fas fa-star"></i>
              Write Review
            </button>
          `;
        } else if (order.status === "shipped") {
          actions += `
            <button class="btn btn-primary" onclick="trackOrderById('${order.orderId}')">
              <i class="fas fa-truck"></i>
              Track Order
            </button>
            <button class="btn btn-success" onclick="reorder('${order.orderId}')">
              <i class="fas fa-redo"></i>
              Reorder
            </button>
          `;
        } else if (order.status === "processing") {
          actions += `
            <button class="btn btn-primary" onclick="trackOrderById('${order.orderId}')">
              <i class="fas fa-truck"></i>
              Track Order
            </button>
            <button class="btn btn-danger" onclick="cancelOrder('${order.orderId}')">
              <i class="fas fa-times"></i>
              Cancel Order
            </button>
          `;
        } else if (order.status === "cancelled") {
          actions += `
            <button class="btn btn-success" onclick="reorder('${order.orderId}')">
              <i class="fas fa-redo"></i>
              Reorder
            </button>
          `;
        }

        return actions;
      }

      // Track order by ID
      async function trackOrderById(orderId) {
        // Switch to track tab and populate the search field
        switchTab("track");
        document.getElementById("orderNumber").value = orderId;
        await trackOrder();
      }

      // Track order
      async function trackOrder() {
        const orderNumber = document.getElementById("orderNumber").value.trim();
        const trackingResults = document.getElementById("trackingResults");

        if (!orderNumber) {
          alert("Please enter an order number");
          return;
        }

        trackingResults.innerHTML = `
          <div class="loading-state">
            <i class="fas fa-spinner"></i>
            <h3>Searching for Order...</h3>
            <p>Please wait while we find your order.</p>
          </div>
        `;

        try {
          const response = await fetch(
            `http://localhost:8000/api/orders/track?orderId=${encodeURIComponent(
              orderNumber.toUpperCase()
            )}`
          );

          if (response.ok) {
            const result = await response.json();
            const order = result.data;

            trackingResults.innerHTML = createTrackingCard(order);
          } else if (response.status === 404) {
            trackingResults.innerHTML = `
              <div class="error-state">
                <i class="fas fa-search"></i>
                <h3>Order Not Found</h3>
                <p>We couldn't find an order with that number. Please check your order number and try again.</p>
                <button onclick="document.getElementById('orderNumber').value = ''; document.getElementById('trackingResults').innerHTML = '';" class="btn btn-primary" style="margin-top: 20px;">
                  <i class="fas fa-redo"></i> Try Again
                </button>
              </div>
            `;
          } else {
            throw new Error("Failed to track order");
          }
        } catch (error) {
          console.error("Failed to track order:", error);
          trackingResults.innerHTML = `
            <div class="error-state">
              <i class="fas fa-exclamation-triangle"></i>
              <h3>Error Tracking Order</h3>
              <p>Failed to track your order. Please try again later.</p>
              <button onclick="trackOrder()" class="btn btn-primary" style="margin-top: 20px;">
                <i class="fas fa-refresh"></i> Try Again
              </button>
            </div>
          `;
        }
      }

      // Create tracking card
      function createTrackingCard(order) {
        return `
          <div class="order-card">
            <div class="order-header">
              <div class="order-info">
                <h3>Order #${order.orderId}</h3>
                <p class="order-date">${new Date(
                  order.date
                ).toLocaleDateString()}</p>
              </div>
              <div class="order-status">
                <span class="status-badge ${order.status}">${
          order.status.charAt(0).toUpperCase() + order.status.slice(1)
        }</span>
                <span class="payment-status">Payment: ${
                  order.paymentStatus
                }</span>
              </div>
            </div>
            
            <div class="order-items-preview">
              ${order.items
                .map(
                  (item) => `
                <div class="item-preview">
                  <div class="item-info">
                    <h4>${item.name}</h4>
                    <p>Qty: ${item.quantity || 1} | Price: ${item.price}</p>
                  </div>
                </div>
              `
                )
                .join("")}
            </div>

            <div class="order-footer">
              <div class="order-total">
                <span>Total: ${order.total}</span>
              </div>
              <div class="order-actions">
                <button class="btn btn-secondary" onclick="viewOrderDetails('${
                  order.orderId
                }')">
                  <i class="fas fa-eye"></i>
                  View Details
                </button>
                ${
                  order.status === "completed"
                    ? `
                  <button class="btn btn-success" onclick="reorder('${order.orderId}')">
                    <i class="fas fa-redo"></i>
                    Reorder
                  </button>
                `
                    : ""
                }
              </div>
            </div>
          </div>
        `;
      }

      // Order action functions
      function viewOrderDetails(orderId) {
        alert(`Viewing details for order ${orderId}`);
        // Implement order details modal or redirect to details page
      }

      function reorder(orderId) {
        alert(`Reordering items from order ${orderId}`);
        // Implement reorder functionality
      }

      function writeReview(orderId) {
        alert(`Writing review for order ${orderId}`);
        // Implement review functionality
      }

      function cancelOrder(orderId) {
        if (confirm(`Are you sure you want to cancel order ${orderId}?`)) {
          alert(`Order ${orderId} cancelled`);
          // Implement cancel order functionality
        }
      }

      // Load cart items for order creation
      function loadCartItems() {
        const cartData = localStorage.getItem("cartItems");
        const cartItemsDisplay = document.getElementById("cartItemsDisplay");
        const orderTotal = document.getElementById("orderTotal");

        if (!cartData) {
          cartItemsDisplay.innerHTML = `
             <div style="text-align: center; padding: 40px; color: #6c757d;">
               <i class="fas fa-shopping-cart" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.3;"></i>
               <h4>Your cart is empty</h4>
               <p>Add some items to your cart before creating an order.</p>
               <a href="index.html" class="btn btn-primary" style="margin-top: 15px; text-decoration: none;">
                 <i class="fas fa-shopping-bag"></i> Start Shopping
               </a>
             </div>
           `;
          orderTotal.textContent = "0frw";
          return;
        }

        try {
          const cartItems = JSON.parse(cartData);
          let total = 0;

          cartItemsDisplay.innerHTML = "";
          cartItems.forEach((item) => {
            const price = parseFloat(item.price.replace(/[^\d.]/g, ""));
            const itemTotal = price * (item.quantity || 1);
            total += itemTotal;

            cartItemsDisplay.innerHTML += `
               <div class="cart-item">
                 <div class="item-info">
                   <div class="item-details">
                     <h5>${item.name}</h5>
                     <p>Price: ${item.price}</p>
                   </div>
                 </div>
                 <div class="quantity-controls">
                   <button class="qty-btn" onclick="decrementQuantity(${
                     item.id
                   })">
                     <i class="fas fa-minus"></i>
                   </button>
                   <span class="qty-display">${item.quantity || 1}</span>
                   <button class="qty-btn" onclick="incrementQuantity(${
                     item.id
                   })">
                     <i class="fas fa-plus"></i>
                   </button>
                   <button class="remove-btn" onclick="removeItem(${item.id})">
                     <i class="fas fa-trash"></i>
                   </button>
                 </div>
               </div>
             `;
          });

          orderTotal.textContent = `${total.toLocaleString()}frw`;
        } catch (error) {
          console.error("Error loading cart items:", error);
          cartItemsDisplay.innerHTML = `
             <div style="text-align: center; padding: 20px; color: #dc3545;">
               <i class="fas fa-exclamation-triangle"></i>
               <p>Error loading cart items</p>
             </div>
           `;
        }
      }

      // Clean price format
      function cleanPrice(price) {
        if (!price) return "0";
        return price.toString().replace(/[^\d.]/g, "");
      }

      // Handle order form submission
      document
        .getElementById("orderForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const btn = document.getElementById("createOrderBtn");
          const cartData = localStorage.getItem("cartItems");

          if (!cartData) {
            alert(
              "Your cart is empty. Please add items before creating an order."
            );
            return;
          }

          try {
            const cartItems = JSON.parse(cartData);

            // Format cart items
            const formattedItems = cartItems.map((item) => ({
              name: item.name || item.title || "Unknown Item",
              price: cleanPrice(item.price) || "0",
              quantity: item.quantity || 1,
              image: item.image || item.src || null,
            }));

            // Get form data
            const formData = new FormData(this);
            const orderData = {
              customerInfo: {
                email: formData.get("email"),
                phone: formData.get("phone"),
                firstName: formData.get("firstName"),
                lastName: formData.get("lastName"),
                address: formData.get("address"),
                city: formData.get("city"),
                country: formData.get("country"),
              },
              items: formattedItems,
              paymentMethod: formData.get("paymentMethod"),
              momoCode: formData.get("momoCode") || null,
              total: cleanPrice(
                document.getElementById("orderTotal").textContent
              ),
            };

            // Show loading state
            btn.innerHTML =
              '<i class="fas fa-spinner fa-spin"></i> Creating Order...';
            btn.disabled = true;

            // Create order
            const createdOrder = await createOrder(orderData);

            // Clear cart
            localStorage.removeItem("cartItems");
            localStorage.removeItem("cartCount");

            // Show success message
            alert(`🎉 Order #${createdOrder.orderId} created successfully!`);

            // Switch to orders tab to show the new order
            switchTab("all");
            loadOrderHistory();

            // Reset form
            this.reset();
            loadCartItems();
          } catch (error) {
            console.error("Order creation failed:", error);
            alert(`Failed to create order: ${error.message}`);
          } finally {
            // Reset button
            btn.innerHTML = '<i class="fas fa-lock"></i> Create Order';
            btn.disabled = false;
          }
        });

      // Quantity control functions
      function incrementQuantity(itemId) {
        const cartData = localStorage.getItem("cartItems");
        if (!cartData) return;

        const cartItems = JSON.parse(cartData);
        const item = cartItems.find((item) => item.id === itemId);

        if (item) {
          item.quantity = (item.quantity || 1) + 1;
          localStorage.setItem("cartItems", JSON.stringify(cartItems));
          loadCartItems(); // Refresh display
        }
      }

      function decrementQuantity(itemId) {
        const cartData = localStorage.getItem("cartItems");
        if (!cartData) return;

        const cartItems = JSON.parse(cartData);
        const item = cartItems.find((item) => item.id === itemId);

        if (item && item.quantity > 1) {
          item.quantity = item.quantity - 1;
          localStorage.setItem("cartItems", JSON.stringify(cartItems));
          loadCartItems(); // Refresh display
        }
      }

      function removeItem(itemId) {
        const cartData = localStorage.getItem("cartItems");
        if (!cartData) return;

        const cartItems = JSON.parse(cartData);
        const filteredItems = cartItems.filter((item) => item.id !== itemId);

        localStorage.setItem("cartItems", JSON.stringify(filteredItems));

        // Update cart count
        const cartCount = filteredItems.reduce(
          (total, item) => total + (item.quantity || 1),
          0
        );
        localStorage.setItem("cartCount", cartCount.toString());

        loadCartItems(); // Refresh display

        // Show message if cart is empty
        if (filteredItems.length === 0) {
          setTimeout(() => {
            alert("Cart is now empty. Add items to continue shopping!");
          }, 100);
        }
      }

      // Initialize page
      // Handle payment method selection
      function handlePaymentMethodChange() {
        const paymentMethods = document.querySelectorAll(
          'input[name="paymentMethod"]'
        );
        const momoCodeGroup = document.getElementById("momoCodeGroup");
        const momoCodeInput = document.getElementById("momoCode");

        paymentMethods.forEach((method) => {
          method.addEventListener("change", function () {
            if (this.value === "momo_code") {
              momoCodeGroup.style.display = "block";
              momoCodeInput.required = true;
            } else {
              momoCodeGroup.style.display = "none";
              momoCodeInput.required = false;
            }
          });
        });
      }

      document.addEventListener("DOMContentLoaded", function () {
        loadCartItems();
        handlePaymentMethodChange();
      });
    </script>
  </body>
</html>
