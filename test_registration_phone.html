<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Registration with Phone 0780146863</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .test-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 6px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .pending { background: #ffc107; }
        .success { background: #28a745; }
        .error { background: #dc3545; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üß™ Test Registration with Phone: 0780146863</h1>
        <p>This page tests the registration process with the specific phone number you provided.</p>

        <!-- Registration Test -->
        <div class="test-section">
            <h3>
                <span class="status-indicator pending" id="regStatus"></span>
                1. User Registration Test
            </h3>
            <p>Test registration with phone number: <strong>0780146863</strong></p>
            
            <div class="form-group">
                <label class="form-label">First Name:</label>
                <input type="text" id="firstName" class="form-input" value="Test" />
            </div>
            
            <div class="form-group">
                <label class="form-label">Last Name:</label>
                <input type="text" id="lastName" class="form-input" value="User" />
            </div>
            
            <div class="form-group">
                <label class="form-label">Email:</label>
                <input type="email" id="email" class="form-input" value="testuser@example.com" />
            </div>
            
            <div class="form-group">
                <label class="form-label">Phone Number:</label>
                <input type="tel" id="phone" class="form-input" value="0780146863" readonly />
            </div>
            
            <div class="form-group">
                <label class="form-label">Address:</label>
                <input type="text" id="address" class="form-input" value="Test Address, Kigali" />
            </div>
            
            <div class="form-group">
                <label class="form-label">City:</label>
                <input type="text" id="city" class="form-input" value="Kigali" />
            </div>
            
            <div class="form-group">
                <label class="form-label">Country:</label>
                <select id="country" class="form-input">
                    <option value="Rwanda" selected>Rwanda</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Password:</label>
                <input type="password" id="password" class="form-input" value="TestPass123" />
            </div>
            
            <button class="test-button" onclick="testRegistration()">Test Registration</button>
            <div id="regResult" class="result" style="display: none;"></div>
        </div>

        <!-- Verification Test -->
        <div class="test-section">
            <h3>
                <span class="status-indicator pending" id="verStatus"></span>
                2. Phone Verification Test
            </h3>
            <p>Test phone verification with the generated OTP code</p>
            
            <div class="form-group">
                <label class="form-label">User ID:</label>
                <input type="text" id="userId" class="form-input" placeholder="Will be filled after registration" readonly />
            </div>
            
            <div class="form-group">
                <label class="form-label">Phone Verification Code:</label>
                <input type="text" id="phoneCode" class="form-input" placeholder="6-digit code" maxlength="6" />
            </div>
            
            <button class="test-button" onclick="testPhoneVerification()" id="verifyBtn" disabled>Verify Phone</button>
            <div id="verResult" class="result" style="display: none;"></div>
        </div>

        <!-- Complete Flow Test -->
        <div class="test-section">
            <h3>
                <span class="status-indicator pending" id="completeStatus"></span>
                3. Complete Flow Test
            </h3>
            <p>Test the complete registration and verification flow</p>
            <button class="test-button" onclick="testCompleteFlow()">Run Complete Test</button>
            <div id="completeResult" class="result" style="display: none;"></div>
        </div>
    </div>

    <script>
        let currentUserId = null;
        let phoneVerificationCode = null;

        function showResult(elementId, message, type = "info") {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `result ${type}`;
            element.style.display = "block";
        }

        function updateStatus(statusId, status) {
            const element = document.getElementById(statusId);
            element.className = `status-indicator ${status}`;
        }

        function setButtonLoading(button, loading) {
            button.disabled = loading;
            button.textContent = loading ? "Loading..." : button.textContent.replace("Loading...", "");
        }

        async function testRegistration() {
            updateStatus("regStatus", "pending");
            setButtonLoading(event.target, true);

            const userData = {
                email: document.getElementById("email").value,
                password: document.getElementById("password").value,
                firstName: document.getElementById("firstName").value,
                lastName: document.getElementById("lastName").value,
                phone: document.getElementById("phone").value,
                address: document.getElementById("address").value,
                city: document.getElementById("city").value,
                country: document.getElementById("country").value
            };

            try {
                const response = await fetch("http://localhost:8000/api/auth/register", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify(userData),
                });

                const result = await response.json();

                if (response.ok) {
                    currentUserId = result.data.user_id;
                    phoneVerificationCode = result.data.verification.phone_code;
                    
                    document.getElementById("userId").value = currentUserId;
                    document.getElementById("phoneCode").value = phoneVerificationCode;
                    document.getElementById("verifyBtn").disabled = false;

                    showResult("regResult", 
                        `‚úÖ Registration Successful!\n\n` +
                        `User ID: ${currentUserId}\n` +
                        `Email: ${result.data.email}\n` +
                        `Phone: ${result.data.phone}\n` +
                        `Phone Code: ${phoneVerificationCode}\n` +
                        `Email Code: ${result.data.verification.email_code}\n\n` +
                        `Please use the phone code above for verification.`, 
                        "success"
                    );
                    updateStatus("regStatus", "success");
                } else {
                    showResult("regResult", 
                        `‚ùå Registration Failed!\n\n` +
                        `Status: ${response.status}\n` +
                        `Message: ${result.message}\n\n` +
                        `Full Response: ${JSON.stringify(result, null, 2)}`, 
                        "error"
                    );
                    updateStatus("regStatus", "error");
                }
            } catch (error) {
                showResult("regResult", 
                    `‚ùå Network Error!\n\n` +
                    `Error: ${error.message}\n\n` +
                    `Please check if the server is running on localhost:8000`, 
                    "error"
                );
                updateStatus("regStatus", "error");
            } finally {
                setButtonLoading(event.target, false);
            }
        }

        async function testPhoneVerification() {
            if (!currentUserId) {
                showResult("verResult", "Please register first!", "error");
                return;
            }

            updateStatus("verStatus", "pending");
            setButtonLoading(event.target, true);

            const code = document.getElementById("phoneCode").value;

            try {
                const response = await fetch("http://localhost:8000/api/auth/verify", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        userId: currentUserId,
                        code: code,
                        type: "phone"
                    }),
                });

                const result = await response.json();

                if (response.ok) {
                    showResult("verResult", 
                        `‚úÖ Phone Verification Successful!\n\n` +
                        `Message: ${result.message}\n\n` +
                        `Full Response: ${JSON.stringify(result, null, 2)}`, 
                        "success"
                    );
                    updateStatus("verStatus", "success");
                } else {
                    showResult("verResult", 
                        `‚ùå Phone Verification Failed!\n\n` +
                        `Status: ${response.status}\n` +
                        `Message: ${result.message}\n\n` +
                        `Full Response: ${JSON.stringify(result, null, 2)}`, 
                        "error"
                    );
                    updateStatus("verStatus", "error");
                }
            } catch (error) {
                showResult("verResult", 
                    `‚ùå Network Error!\n\n` +
                    `Error: ${error.message}`, 
                    "error"
                );
                updateStatus("verStatus", "error");
            } finally {
                setButtonLoading(event.target, false);
            }
        }

        async function testCompleteFlow() {
            updateStatus("completeStatus", "pending");
            setButtonLoading(event.target, true);

            try {
                // Step 1: Registration
                showResult("completeResult", "üîÑ Step 1: Testing registration...", "info");
                
                const userData = {
                    email: `test${Date.now()}@example.com`,
                    password: "TestPass123",
                    firstName: "Test",
                    lastName: "User",
                    phone: "0780146863",
                    address: "Test Address, Kigali",
                    city: "Kigali",
                    country: "Rwanda"
                };

                const regResponse = await fetch("http://localhost:8000/api/auth/register", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(userData),
                });

                const regResult = await regResponse.json();

                if (!regResponse.ok) {
                    throw new Error(`Registration failed: ${regResult.message}`);
                }

                currentUserId = regResult.data.user_id;
                phoneVerificationCode = regResult.data.verification.phone_code;

                showResult("completeResult", 
                    `‚úÖ Step 1 Complete: Registration successful!\n` +
                    `User ID: ${currentUserId}\n` +
                    `Phone Code: ${phoneVerificationCode}\n\n` +
                    `üîÑ Step 2: Testing phone verification...`, 
                    "success"
                );

                // Step 2: Phone Verification
                const verResponse = await fetch("http://localhost:8000/api/auth/verify", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        userId: currentUserId,
                        code: phoneVerificationCode,
                        type: "phone"
                    }),
                });

                const verResult = await verResponse.json();

                if (!verResponse.ok) {
                    throw new Error(`Phone verification failed: ${verResult.message}`);
                }

                showResult("completeResult", 
                    `‚úÖ Complete Flow Test Successful!\n\n` +
                    `‚úÖ Registration: SUCCESS\n` +
                    `‚úÖ Phone Verification: SUCCESS\n\n` +
                    `Phone Number: 0780146863\n` +
                    `User ID: ${currentUserId}\n` +
                    `Phone Code: ${phoneVerificationCode}\n\n` +
                    `The registration and verification system is working correctly!`, 
                    "success"
                );
                updateStatus("completeStatus", "success");

            } catch (error) {
                showResult("completeResult", 
                    `‚ùå Complete Flow Test Failed!\n\n` +
                    `Error: ${error.message}\n\n` +
                    `Please check the server logs for more details.`, 
                    "error"
                );
                updateStatus("completeStatus", "error");
            } finally {
                setButtonLoading(event.target, false);
            }
        }
    </script>
</body>
</html>


