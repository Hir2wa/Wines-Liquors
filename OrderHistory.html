<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Order History - Total Wine & More</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="Header.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
  </head>
  <body>
    <div class="order-history-container">
      <!-- Header -->
      <header class="order-history-header">
        <div class="container">
          <div class="header-content">
            <a href="index.html" class="back-link">
              <i class="fas fa-arrow-left"></i>
              Back to Home
            </a>
            <div class="logo">
              <img src="images/logo.png" alt="Total Wine & More Logo" />
            </div>
            <div class="header-actions">
              <a href="MyOrders.html" class="cart-btn">
                <i class="fas fa-shopping-cart"></i>
                <span class="cart-count">0</span>
              </a>
            </div>
          </div>
        </div>
      </header>

      <!-- Order History Section -->
      <section class="order-history-section">
        <div class="container">
          <div class="history-header">
            <h1>Order History</h1>
            <p>View and manage your past orders</p>
          </div>

          <!-- Filter Options -->
          <div class="order-filters">
            <div class="filter-group">
              <label>Filter by Status:</label>
              <select id="statusFilter" onchange="filterOrders()">
                <option value="all">All Orders</option>
                <option value="completed">Completed</option>
                <option value="shipped">Shipped</option>
                <option value="processing">Processing</option>
                <option value="cancelled">Cancelled</option>
              </select>
            </div>
            <div class="filter-group">
              <label>Date Range:</label>
              <select id="dateFilter" onchange="filterOrders()">
                <option value="all">All Time</option>
                <option value="last30">Last 30 Days</option>
                <option value="last90">Last 90 Days</option>
                <option value="lastyear">Last Year</option>
              </select>
            </div>
          </div>

          <!-- Orders List -->
          <div class="orders-list">
            <!-- Order 1 -->
            <div
              class="order-card"
              data-status="shipped"
              data-date="2024-01-15"
            >
              <div class="order-header">
                <div class="order-info">
                  <h3>Order #ORD-001</h3>
                  <p class="order-date">January 15, 2024</p>
                </div>
                <div class="order-status">
                  <span class="status-badge shipped">Shipped</span>
                </div>
              </div>

              <div class="order-items-preview">
                <div class="item-preview">
                  <img src="images/WINE1.webp" alt="Wine" />
                  <div class="item-info">
                    <h4>Lallier Champagne</h4>
                    <p>Qty: 2</p>
                  </div>
                </div>
                <div class="item-preview">
                  <img src="images/WINE2.webp" alt="Wine" />
                  <div class="item-info">
                    <h4>Swiftsure Marlborough</h4>
                    <p>Qty: 1</p>
                  </div>
                </div>
                <div class="more-items">
                  <span>+1 more item</span>
                </div>
              </div>

              <div class="order-footer">
                <div class="order-total">
                  <span>Total: $125.00</span>
                </div>
                <div class="order-actions">
                  <button
                    class="btn-secondary"
                    onclick="viewOrderDetails('ORD-001')"
                  >
                    <i class="fas fa-eye"></i>
                    View Details
                  </button>
                  <button class="btn-primary" onclick="trackOrder('ORD-001')">
                    <i class="fas fa-truck"></i>
                    Track Order
                  </button>
                  <button class="btn-success" onclick="reorder('ORD-001')">
                    <i class="fas fa-redo"></i>
                    Reorder
                  </button>
                </div>
              </div>
            </div>

            <!-- Order 2 -->
            <div
              class="order-card"
              data-status="completed"
              data-date="2024-01-10"
            >
              <div class="order-header">
                <div class="order-info">
                  <h3>Order #ORD-002</h3>
                  <p class="order-date">January 10, 2024</p>
                </div>
                <div class="order-status">
                  <span class="status-badge completed">Completed</span>
                </div>
              </div>

              <div class="order-items-preview">
                <div class="item-preview">
                  <img src="images/WINE3.webp" alt="Wine" />
                  <div class="item-info">
                    <h4>Premium Red Wine</h4>
                    <p>Qty: 1</p>
                  </div>
                </div>
                <div class="item-preview">
                  <img src="images/WINE4.webp" alt="Wine" />
                  <div class="item-info">
                    <h4>Elegant White Wine</h4>
                    <p>Qty: 2</p>
                  </div>
                </div>
              </div>

              <div class="order-footer">
                <div class="order-total">
                  <span>Total: $89.50</span>
                </div>
                <div class="order-actions">
                  <button
                    class="btn-secondary"
                    onclick="viewOrderDetails('ORD-002')"
                  >
                    <i class="fas fa-eye"></i>
                    View Details
                  </button>
                  <button class="btn-success" onclick="reorder('ORD-002')">
                    <i class="fas fa-redo"></i>
                    Reorder
                  </button>
                  <button class="btn-warning" onclick="writeReview('ORD-002')">
                    <i class="fas fa-star"></i>
                    Write Review
                  </button>
                </div>
              </div>
            </div>

            <!-- Order 3 -->
            <div
              class="order-card"
              data-status="processing"
              data-date="2024-01-12"
            >
              <div class="order-header">
                <div class="order-info">
                  <h3>Order #ORD-003</h3>
                  <p class="order-date">January 12, 2024</p>
                </div>
                <div class="order-status">
                  <span class="status-badge processing">Processing</span>
                </div>
              </div>

              <div class="order-items-preview">
                <div class="item-preview">
                  <img src="images/WINE1.webp" alt="Wine" />
                  <div class="item-info">
                    <h4>Lallier Champagne</h4>
                    <p>Qty: 3</p>
                  </div>
                </div>
              </div>

              <div class="order-footer">
                <div class="order-total">
                  <span>Total: $135.00</span>
                </div>
                <div class="order-actions">
                  <button
                    class="btn-secondary"
                    onclick="viewOrderDetails('ORD-003')"
                  >
                    <i class="fas fa-eye"></i>
                    View Details
                  </button>
                  <button class="btn-primary" onclick="trackOrder('ORD-003')">
                    <i class="fas fa-truck"></i>
                    Track Order
                  </button>
                  <button class="btn-danger" onclick="cancelOrder('ORD-003')">
                    <i class="fas fa-times"></i>
                    Cancel Order
                  </button>
                </div>
              </div>
            </div>

            <!-- Order 4 -->
            <div
              class="order-card"
              data-status="cancelled"
              data-date="2024-01-08"
            >
              <div class="order-header">
                <div class="order-info">
                  <h3>Order #ORD-004</h3>
                  <p class="order-date">January 8, 2024</p>
                </div>
                <div class="order-status">
                  <span class="status-badge cancelled">Cancelled</span>
                </div>
              </div>

              <div class="order-items-preview">
                <div class="item-preview">
                  <img src="images/WINE2.webp" alt="Wine" />
                  <div class="item-info">
                    <h4>Swiftsure Marlborough</h4>
                    <p>Qty: 1</p>
                  </div>
                </div>
              </div>

              <div class="order-footer">
                <div class="order-total">
                  <span>Total: $35.00</span>
                </div>
                <div class="order-actions">
                  <button
                    class="btn-secondary"
                    onclick="viewOrderDetails('ORD-004')"
                  >
                    <i class="fas fa-eye"></i>
                    View Details
                  </button>
                  <button class="btn-success" onclick="reorder('ORD-004')">
                    <i class="fas fa-redo"></i>
                    Reorder
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Pagination -->
          <div class="pagination">
            <button class="btn-pagination" disabled>
              <i class="fas fa-chevron-left"></i>
              Previous
            </button>
            <span class="page-info">Page 1 of 3</span>
            <button class="btn-pagination">
              Next
              <i class="fas fa-chevron-right"></i>
            </button>
          </div>
        </div>
      </section>
    </div>

    <script src="js/api-client.js"></script>
    <script>
      function filterOrders() {
        const statusFilter = document.getElementById("statusFilter").value;
        const dateFilter = document.getElementById("dateFilter").value;
        const orderCards = document.querySelectorAll(".order-card");

        orderCards.forEach((card) => {
          let showCard = true;

          // Filter by status
          if (statusFilter !== "all") {
            const cardStatus = card.getAttribute("data-status");
            if (cardStatus !== statusFilter) {
              showCard = false;
            }
          }

          // Filter by date
          if (dateFilter !== "all") {
            const cardDate = new Date(card.getAttribute("data-date"));
            const now = new Date();
            let daysDiff = 0;

            switch (dateFilter) {
              case "last30":
                daysDiff = 30;
                break;
              case "last90":
                daysDiff = 90;
                break;
              case "lastyear":
                daysDiff = 365;
                break;
            }

            if (daysDiff > 0) {
              const diffTime = Math.abs(now - cardDate);
              const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
              if (diffDays > daysDiff) {
                showCard = false;
              }
            }
          }

          card.style.display = showCard ? "block" : "none";
        });
      }

      function viewOrderDetails(orderId) {
        // Redirect to order details page or show modal
        alert(`Viewing details for order ${orderId}`);
      }

      function trackOrder(orderId) {
        // Redirect to tracking page
        window.location.href = `OrderTracking.html?order=${orderId}`;
      }

      function reorder(orderId) {
        if (confirm(`Add all items from order ${orderId} to cart?`)) {
          // Add items to cart
          alert(`Items from order ${orderId} added to cart!`);
        }
      }

      function cancelOrder(orderId) {
        if (confirm(`Are you sure you want to cancel order ${orderId}?`)) {
          // Cancel order
          alert(`Order ${orderId} has been cancelled.`);
          // Update UI
          const orderCard = document.querySelector(`[data-order="${orderId}"]`);
          if (orderCard) {
            orderCard.querySelector(".status-badge").textContent = "Cancelled";
            orderCard.querySelector(".status-badge").className =
              "status-badge cancelled";
          }
        }
      }

      function writeReview(orderId) {
        // Redirect to review page or show review modal
        alert(`Writing review for order ${orderId}`);
      }

      // Initialize page
      document.addEventListener("DOMContentLoaded", function () {
        // Load user's order history
        loadOrderHistory();
      });

      // Check if user is logged in
      function checkLoginStatus() {
        const isLoggedIn = localStorage.getItem("user_logged_in") === "true";
        const userData = localStorage.getItem("userData");

        if (!isLoggedIn || !userData) {
          showLoginPrompt();
          return false;
        }
        return true;
      }

      // Show login prompt
      function showLoginPrompt() {
        const ordersList = document.querySelector(".orders-list");
        ordersList.innerHTML = `
          <div style="text-align: center; padding: 60px 20px; color: #6c757d;">
            <i class="fas fa-user-lock" style="font-size: 4rem; margin-bottom: 20px; opacity: 0.3;"></i>
            <h3>Please Sign In</h3>
            <p>You need to be signed in to view your order history.</p>
            <div style="margin-top: 20px;">
              <a href="login.html" class="btn-primary" style="margin-right: 10px; text-decoration: none;">
                <i class="fas fa-sign-in-alt"></i> Sign In
              </a>
              <a href="Register.html" class="btn-secondary" style="text-decoration: none;">
                <i class="fas fa-user-plus"></i> Create Account
              </a>
            </div>
          </div>
        `;
      }

      async function loadOrderHistory() {
        if (!checkLoginStatus()) {
          return;
        }

        const ordersList = document.querySelector(".orders-list");
        ordersList.innerHTML = `
          <div style="text-align: center; padding: 60px 20px; color: #6c757d;">
            <i class="fas fa-spinner fa-spin" style="font-size: 3rem; margin-bottom: 20px;"></i>
            <h3>Loading Orders...</h3>
            <p>Please wait while we fetch your order history.</p>
          </div>
        `;

        try {
          const sessionToken = localStorage.getItem("sessionToken");

          const response = await fetch(
            "http://localhost:8000/api/orders/customer",
            {
              method: "GET",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${sessionToken}`,
              },
            }
          );

          if (response.ok) {
            const result = await response.json();
            const orders = result.data.orders;

            if (orders.length === 0) {
              ordersList.innerHTML = `
                <div style="text-align: center; padding: 60px 20px; color: #6c757d;">
                  <i class="fas fa-shopping-cart" style="font-size: 4rem; margin-bottom: 20px; opacity: 0.3;"></i>
                  <h3>No Orders Yet</h3>
                  <p>You haven't placed any orders yet. Start shopping to see your order history here.</p>
                  <a href="index.html" class="btn-primary" style="margin-top: 20px; display: inline-block; text-decoration: none;">
                    <i class="fas fa-shopping-bag"></i> Start Shopping
                  </a>
                </div>
              `;
              return;
            }

            ordersList.innerHTML = "";
            orders.forEach((order) => {
              const orderCard = createOrderCard(order);
              ordersList.appendChild(orderCard);
            });
          } else if (response.status === 401) {
            // User not authenticated
            showLoginPrompt();
          } else {
            throw new Error("Failed to load orders");
          }
        } catch (error) {
          console.error("Failed to load order history:", error);
          ordersList.innerHTML = `
            <div style="text-align: center; padding: 60px 20px; color: #dc3545;">
              <i class="fas fa-exclamation-triangle" style="font-size: 4rem; margin-bottom: 20px;"></i>
              <h3>Error Loading Orders</h3>
              <p>Failed to load your order history. Please try again later.</p>
              <button onclick="loadOrderHistory()" class="btn-primary" style="margin-top: 20px;">
                <i class="fas fa-refresh"></i> Try Again
              </button>
            </div>
          `;
        }
      }

      function createOrderCard(order) {
        const orderCard = document.createElement("div");
        orderCard.className = "order-card";
        orderCard.setAttribute("data-status", order.status);
        orderCard.setAttribute("data-date", order.date);

        const itemsPreview = order.items
          .slice(0, 2)
          .map(
            (item) => `
          <div class="item-preview">
            <img src="${item.image || "images/WINE1.webp"}" alt="${
              item.name
            }" />
            <div class="item-info">
              <h4>${item.name}</h4>
              <p>Qty: ${item.quantity || 1}</p>
            </div>
          </div>
        `
          )
          .join("");

        const moreItems =
          order.items.length > 2
            ? `<div class="more-items"><span>+${
                order.items.length - 2
              } more item${order.items.length - 2 > 1 ? "s" : ""}</span></div>`
            : "";

        const actions = getOrderActions(order);

        orderCard.innerHTML = `
          <div class="order-header">
            <div class="order-info">
              <h3>Order #${order.orderId}</h3>
              <p class="order-date">${new Date(
                order.date
              ).toLocaleDateString()}</p>
            </div>
            <div class="order-status">
              <span class="status-badge ${order.status}">${
          order.status.charAt(0).toUpperCase() + order.status.slice(1)
        }</span>
            </div>
          </div>
          
          <div class="order-items-preview">
            ${itemsPreview}
            ${moreItems}
          </div>

          <div class="order-footer">
            <div class="order-total">
              <span>Total: ${order.total}</span>
            </div>
            <div class="order-actions">
              ${actions}
            </div>
          </div>
        `;

        return orderCard;
      }

      function getOrderActions(order) {
        let actions = `
          <button class="btn-secondary" onclick="viewOrderDetails('${order.orderId}')">
            <i class="fas fa-eye"></i>
            View Details
          </button>
        `;

        if (order.status === "completed") {
          actions += `
            <button class="btn-success" onclick="reorder('${order.orderId}')">
              <i class="fas fa-redo"></i>
              Reorder
            </button>
            <button class="btn-warning" onclick="writeReview('${order.orderId}')">
              <i class="fas fa-star"></i>
              Write Review
            </button>
          `;
        } else if (order.status === "shipped") {
          actions += `
            <button class="btn-primary" onclick="trackOrder('${order.orderId}')">
              <i class="fas fa-truck"></i>
              Track Order
            </button>
            <button class="btn-success" onclick="reorder('${order.orderId}')">
              <i class="fas fa-redo"></i>
              Reorder
            </button>
          `;
        } else if (order.status === "processing") {
          actions += `
            <button class="btn-primary" onclick="trackOrder('${order.orderId}')">
              <i class="fas fa-truck"></i>
              Track Order
            </button>
            <button class="btn-danger" onclick="cancelOrder('${order.orderId}')">
              <i class="fas fa-times"></i>
              Cancel Order
            </button>
          `;
        } else if (order.status === "cancelled") {
          actions += `
            <button class="btn-success" onclick="reorder('${order.orderId}')">
              <i class="fas fa-redo"></i>
              Reorder
            </button>
          `;
        }

        return actions;
      }
    </script>
  </body>
</html>
