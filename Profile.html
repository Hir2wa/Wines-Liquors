<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Profile - Total Wine & More</title>
    <link rel="stylesheet" href="css/all.min.css" />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: #f6f6f7;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      .header {
        background: white;
        border-bottom: 1px solid #e1e3e5;
        padding: 0 24px;
        height: 70px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .nav-left {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .back-to-home {
        display: flex;
        align-items: center;
        gap: 8px;
        color: #dc3545;
        text-decoration: none;
        font-weight: 600;
        transition: all 0.3s ease;
        padding: 10px 16px;
        border-radius: 8px;
        background: rgba(220, 53, 69, 0.1);
        border: 1px solid rgba(220, 53, 69, 0.2);
      }

      .back-to-home:hover {
        color: #c82333;
        background: rgba(220, 53, 69, 0.15);
        transform: translateX(-2px);
        border-color: rgba(220, 53, 69, 0.3);
      }

      .back-to-home i {
        font-size: 16px;
      }

      .logo {
        display: flex;
        align-items: center;
      }

      .logo img {
        height: 35px;
        width: auto;
      }

      .nav-right {
        display: flex;
        align-items: center;
        gap: 20px;
      }

      .help-link {
        color: #6c757d;
        text-decoration: none;
        font-size: 14px;
        font-weight: 500;
        transition: color 0.3s ease;
      }

      .help-link:hover {
        color: #dc3545;
      }

      /* Mobile Responsiveness */
      @media (max-width: 768px) {
        .header {
          padding: 0 16px;
          height: 60px;
        }

        .nav-left {
          gap: 12px;
        }

        .back-to-home {
          padding: 8px 12px;
          font-size: 14px;
        }

        .back-to-home span {
          display: none;
        }

        .back-to-home i {
          font-size: 18px;
        }

        .logo img {
          height: 30px;
        }

        .help-link {
          font-size: 12px;
        }
      }

      @media (max-width: 480px) {
        .header {
          padding: 0 12px;
        }

        .nav-left {
          gap: 8px;
        }

        .back-to-home {
          padding: 6px 10px;
        }

        .logo img {
          height: 28px;
        }
      }

      .main-content {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 40px 24px;
      }

      .profile-container {
        background: white;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        padding: 40px;
        width: 100%;
        max-width: 600px;
      }

      .profile-header {
        text-align: center;
        margin-bottom: 40px;
      }

      .profile-avatar {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background: linear-gradient(135deg, #dc3545, #c82333);
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 20px;
        color: white;
        font-size: 40px;
        font-weight: bold;
      }

      .profile-title {
        font-size: 28px;
        font-weight: 700;
        color: #2c3e50;
        margin-bottom: 8px;
      }

      .profile-subtitle {
        color: #6c757d;
        font-size: 16px;
      }

      .profile-info {
        display: grid;
        gap: 24px;
      }

      .info-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .info-label {
        font-weight: 600;
        color: #2c3e50;
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .info-value {
        font-size: 16px;
        color: #495057;
        padding: 12px 16px;
        background: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #e9ecef;
        transition: all 0.3s ease;
      }

      .info-value.editable {
        cursor: pointer;
        position: relative;
      }

      .info-value.editable:hover {
        background: #e9ecef;
        border-color: #dc3545;
      }

      .info-value.editing {
        background: white;
        border: 2px solid #dc3545;
        box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.1);
      }

      .info-value input {
        width: 100%;
        border: none;
        background: transparent;
        font-size: 16px;
        color: #495057;
        outline: none;
        padding: 0;
      }

      .edit-icon {
        position: absolute;
        right: 8px;
        top: 50%;
        transform: translateY(-50%);
        color: #6c757d;
        font-size: 12px;
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .info-value.editable:hover .edit-icon {
        opacity: 1;
      }

      .save-cancel-buttons {
        display: none;
        gap: 8px;
        margin-top: 8px;
      }

      .save-cancel-buttons.show {
        display: flex;
      }

      .btn-small {
        padding: 6px 12px;
        font-size: 12px;
        border-radius: 4px;
      }

      .btn-success {
        background: #28a745;
        color: white;
      }

      .btn-success:hover {
        background: #218838;
      }

      .btn-outline-secondary {
        background: transparent;
        color: #6c757d;
        border: 1px solid #6c757d;
      }

      .btn-outline-secondary:hover {
        background: #6c757d;
        color: white;
      }

      .admin-mode-switch {
        margin-top: 40px;
        padding: 30px;
        background: linear-gradient(135deg, #dc3545, #c82333);
        border-radius: 12px;
        color: white;
        text-align: center;
      }

      .admin-mode-switch h3 {
        color: white;
        margin-bottom: 20px;
        font-size: 1.3rem;
      }

      .admin-actions {
        display: flex;
        flex-direction: column;
        gap: 20px;
        align-items: center;
      }

      .current-mode {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 16px;
        font-weight: 500;
      }

      .current-mode i {
        font-size: 20px;
      }

      .mode-buttons {
        display: flex;
        gap: 16px;
        justify-content: center;
        flex-wrap: wrap;
      }

      .order-management {
        margin-top: 40px;
        padding: 30px;
        background: #f8f9fa;
        border-radius: 12px;
        border: 1px solid #e9ecef;
      }

      .order-management h3 {
        color: #2c3e50;
        margin-bottom: 20px;
        text-align: center;
        font-size: 1.3rem;
      }

      .order-actions {
        display: flex;
        gap: 16px;
        justify-content: center;
        flex-wrap: wrap;
      }

      .order-actions .btn {
        min-width: 150px;
        text-align: center;
        text-decoration: none;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }

      .profile-actions {
        margin-top: 40px;
        display: flex;
        gap: 16px;
        justify-content: center;
      }

      .btn {
        padding: 12px 24px;
        border-radius: 8px;
        font-weight: 600;
        text-decoration: none;
        transition: all 0.3s ease;
        border: none;
        cursor: pointer;
        font-size: 14px;
      }

      .btn-primary {
        background: #dc3545;
        color: white;
      }

      .btn-primary:hover {
        background: #c82333;
        transform: translateY(-1px);
      }

      .btn-secondary {
        background: #6c757d;
        color: white;
      }

      .btn-secondary:hover {
        background: #5a6268;
        transform: translateY(-1px);
      }

      .login-prompt {
        text-align: center;
        padding: 60px 40px;
      }

      .login-prompt h2 {
        color: #2c3e50;
        margin-bottom: 16px;
        font-size: 24px;
      }

      .login-prompt p {
        color: #6c757d;
        margin-bottom: 32px;
        font-size: 16px;
      }

      .login-actions {
        display: flex;
        gap: 16px;
        justify-content: center;
        flex-wrap: wrap;
      }

      @media (max-width: 768px) {
        .profile-container {
          padding: 30px 20px;
        }

        .order-actions {
          flex-direction: column;
        }

        .order-actions .btn {
          min-width: auto;
          width: 100%;
        }

        .profile-actions {
          flex-direction: column;
        }

        .login-actions {
          flex-direction: column;
        }
      }

      /* Loading Spinner Styles */
      .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #dc3545;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 8px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
      }

      .loading-content {
        background: white;
        padding: 30px;
        border-radius: 12px;
        text-align: center;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      }

      .loading-content .loading-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #dc3545;
        margin: 0 auto 15px;
      }

      /* Loading styles */
      .loading-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 60px 20px;
        text-align: center;
      }

      .loading-spinner {
        font-size: 48px;
        color: #dc3545;
        margin-bottom: 20px;
      }

      .loading-container p {
        color: #6c757d;
        font-size: 16px;
        margin: 0;
      }
    </style>
  </head>
  <body>
    <header class="header">
      <div class="nav-left">
        <a href="index.html" class="back-to-home">
          <i class="fas fa-home"></i>
          <span>Home</span>
        </a>
        <div class="logo">
          <img
            src="images/logo1.png"
            alt="Total Wine & More Logo"
            style="width: 150px"
          />
        </div>
      </div>
      <div class="nav-right">
        <a href="#" class="help-link">Need help?</a>
      </div>
    </header>

    <main class="main-content">
      <div class="profile-container">
        <div id="profile-content">
          <!-- Profile content will be loaded here -->
        </div>
      </div>
    </main>

    <script>
      // Loading functions
      function showLoading(message = "Loading...") {
        const overlay = document.createElement("div");
        overlay.className = "loading-overlay";
        overlay.id = "loading-overlay";
        overlay.innerHTML = `
          <div class="loading-content">
            <div class="loading-spinner"></div>
            <p>${message}</p>
          </div>
        `;
        document.body.appendChild(overlay);
      }

      function hideLoading() {
        const overlay = document.getElementById("loading-overlay");
        if (overlay) {
          overlay.remove();
        }
      }

      // Check if user is logged in and load profile data
      async function loadProfile() {
        showLoading("Loading profile...");
        const userData = localStorage.getItem("userData");
        const profileContent = document.getElementById("profile-content");

        if (!userData) {
          // User not logged in - show login prompt
          profileContent.innerHTML = `
            <div class="login-prompt">
              <div class="profile-avatar">
                <i class="fas fa-user"></i>
              </div>
              <h2>Welcome to Total Wine & More</h2>
              <p>Please sign in to view your profile and manage your account.</p>
              <div class="login-actions">
                <a href="login.html" class="btn btn-primary">
                  <i class="fas fa-sign-in-alt"></i> Sign In
                </a>
                <a href="Register.html" class="btn btn-secondary">
                  <i class="fas fa-user-plus"></i> Create Account
                </a>
              </div>
            </div>
          `;
        } else {
          // User is logged in - show loading first
          profileContent.innerHTML = `
            <div class="loading-container">
              <div class="loading-spinner">
                <i class="fas fa-spinner fa-spin"></i>
              </div>
              <p>Loading your profile...</p>
            </div>
          `;

          try {
            // Get fresh profile data from API
            const user = JSON.parse(userData);
            const sessionToken = localStorage.getItem("sessionToken");

            console.log("Loading profile for user:", user.email);
            console.log("Session token:", sessionToken ? "Present" : "Missing");

            if (!sessionToken) {
              console.log("No session token, using localStorage data");
              displayProfile(user);
              hideLoading();
              return;
            }

            const response = await fetch("/api/profile", {
              method: "GET",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${sessionToken}`,
              },
            });

            console.log("Profile API response status:", response.status);

            if (response.ok) {
              const result = await response.json();
              console.log("Profile API response:", result);
              const profileData = result.data;

              // Update localStorage with fresh data
              const updatedUserData = {
                id: profileData.id,
                firstName: profileData.firstName,
                lastName: profileData.lastName,
                email: profileData.email,
                phone: profileData.phone,
                dateOfBirth: profileData.dateOfBirth,
                gender: profileData.gender,
                address: profileData.address,
                city: profileData.city,
                country: profileData.country,
                isVerified: profileData.isVerified,
                emailVerified: profileData.emailVerified,
                phoneVerified: profileData.phoneVerified,
              };

              localStorage.setItem("userData", JSON.stringify(updatedUserData));

              // Display profile with fresh data
              displayProfile(updatedUserData);
            } else {
              // Fallback to localStorage data if API fails
              const errorText = await response.text();
              console.log("Profile API failed:", response.status, errorText);
              console.log("Using localStorage data as fallback");
              displayProfile(user);
            }
            hideLoading();
          } catch (error) {
            console.error("Error fetching profile:", error);
            // Fallback to localStorage data
            const user = JSON.parse(userData);
            displayProfile(user);
            hideLoading();
          }
        }
      }

      // Display profile data
      function displayProfile(user) {
        const profileContent = document.getElementById("profile-content");
        const firstName = user.firstName || "User";
        const lastName = user.lastName || "";
        const email = user.email || "";
        const phone = user.phone || "";
        const dateOfBirth = user.dateOfBirth || "";
        const address = user.address || "";
        const city = user.city || "";
        const country = user.country || "";
        const gender = user.gender || "";
        const state = user.state || "";
        const zipCode = user.zipCode || "";

        profileContent.innerHTML = `
            <div class="profile-header">
              <div class="profile-avatar">
                ${firstName.charAt(0).toUpperCase()}${lastName
          .charAt(0)
          .toUpperCase()}
              </div>
              <h1 class="profile-title">${firstName} ${lastName}</h1>
              <p class="profile-subtitle">Welcome back to Total Wine & More</p>
            </div>

            <div class="profile-info">
              <div class="info-group">
                <label class="info-label">First Name</label>
                <div class="info-value editable" data-field="firstName" onclick="startEdit(this)">
                  ${firstName || "Not provided"}
                  <i class="fas fa-edit edit-icon"></i>
                </div>
                <div class="save-cancel-buttons">
                  <button class="btn btn-success btn-small" onclick="saveField(this)">Save</button>
                  <button class="btn btn-outline-secondary btn-small" onclick="cancelEdit(this)">Cancel</button>
                </div>
              </div>

              <div class="info-group">
                <label class="info-label">Last Name</label>
                <div class="info-value editable" data-field="lastName" onclick="startEdit(this)">
                  ${lastName || "Not provided"}
                  <i class="fas fa-edit edit-icon"></i>
                </div>
                <div class="save-cancel-buttons">
                  <button class="btn btn-success btn-small" onclick="saveField(this)">Save</button>
                  <button class="btn btn-outline-secondary btn-small" onclick="cancelEdit(this)">Cancel</button>
                </div>
              </div>

              <div class="info-group">
                <label class="info-label">Email Address</label>
                <div class="info-value editable" data-field="email" onclick="startEdit(this)">
                  ${email}
                  <i class="fas fa-edit edit-icon"></i>
                </div>
                <div class="save-cancel-buttons">
                  <button class="btn btn-success btn-small" onclick="saveField(this)">Save</button>
                  <button class="btn btn-outline-secondary btn-small" onclick="cancelEdit(this)">Cancel</button>
                </div>
              </div>

              <div class="info-group">
                <label class="info-label">Phone Number</label>
                <div class="info-value editable" data-field="phone" onclick="startEdit(this)">
                  ${phone || "Not provided"}
                  <i class="fas fa-edit edit-icon"></i>
                </div>
                <div class="save-cancel-buttons">
                  <button class="btn btn-success btn-small" onclick="saveField(this)">Save</button>
                  <button class="btn btn-outline-secondary btn-small" onclick="cancelEdit(this)">Cancel</button>
                </div>
              </div>

              <div class="info-group">
                <label class="info-label">Date of Birth</label>
                <div class="info-value editable" data-field="dateOfBirth" onclick="startEdit(this)">
                  ${dateOfBirth || "Not provided"}
                  <i class="fas fa-edit edit-icon"></i>
                </div>
                <div class="save-cancel-buttons">
                  <button class="btn btn-success btn-small" onclick="saveField(this)">Save</button>
                  <button class="btn btn-outline-secondary btn-small" onclick="cancelEdit(this)">Cancel</button>
                </div>
              </div>

              <div class="info-group">
                <label class="info-label">Gender</label>
                <div class="info-value editable" data-field="gender" onclick="startEdit(this)">
                  ${
                    gender
                      ? gender.charAt(0).toUpperCase() + gender.slice(1)
                      : "Not provided"
                  }
                  <i class="fas fa-edit edit-icon"></i>
                </div>
                <div class="save-cancel-buttons">
                  <button class="btn btn-success btn-small" onclick="saveField(this)">Save</button>
                  <button class="btn btn-outline-secondary btn-small" onclick="cancelEdit(this)">Cancel</button>
                </div>
              </div>

              <div class="info-group">
                <label class="info-label">Address</label>
                <div class="info-value editable" data-field="address" onclick="startEdit(this)">
                  ${address || "Not provided"}
                  <i class="fas fa-edit edit-icon"></i>
                </div>
                <div class="save-cancel-buttons">
                  <button class="btn btn-success btn-small" onclick="saveField(this)">Save</button>
                  <button class="btn btn-outline-secondary btn-small" onclick="cancelEdit(this)">Cancel</button>
                </div>
              </div>

              <div class="info-group">
                <label class="info-label">City</label>
                <div class="info-value editable" data-field="city" onclick="startEdit(this)">
                  ${city || "Not provided"}
                  <i class="fas fa-edit edit-icon"></i>
                </div>
                <div class="save-cancel-buttons">
                  <button class="btn btn-success btn-small" onclick="saveField(this)">Save</button>
                  <button class="btn btn-outline-secondary btn-small" onclick="cancelEdit(this)">Cancel</button>
                </div>
              </div>

              <div class="info-group">
                <label class="info-label">State</label>
                <div class="info-value editable" data-field="state" onclick="startEdit(this)">
                  ${state || "Not provided"}
                  <i class="fas fa-edit edit-icon"></i>
                </div>
                <div class="save-cancel-buttons">
                  <button class="btn btn-success btn-small" onclick="saveField(this)">Save</button>
                  <button class="btn btn-outline-secondary btn-small" onclick="cancelEdit(this)">Cancel</button>
                </div>
              </div>

              <div class="info-group">
                <label class="info-label">ZIP Code</label>
                <div class="info-value editable" data-field="zipCode" onclick="startEdit(this)">
                  ${zipCode || "Not provided"}
                  <i class="fas fa-edit edit-icon"></i>
                </div>
                <div class="save-cancel-buttons">
                  <button class="btn btn-success btn-small" onclick="saveField(this)">Save</button>
                  <button class="btn btn-outline-secondary btn-small" onclick="cancelEdit(this)">Cancel</button>
                </div>
              </div>
            </div>

            ${
              user.isAdmin
                ? `
            <div class="admin-mode-switch">
              <h3>Admin Mode</h3>
              <div class="admin-actions">
                <div class="current-mode">
                  <i class="fas fa-user-shield"></i>
                  <span>You have admin privileges</span>
                </div>
                <div class="mode-buttons">
                  <button class="btn btn-danger" onclick="switchToAdminMode()">
                    <i class="fas fa-cog"></i> Admin Dashboard
                  </button>
                  <button class="btn btn-success" onclick="switchToUserMode()">
                    <i class="fas fa-user"></i> User Mode
                  </button>
                </div>
              </div>
            </div>
            `
                : ""
            }

            <div class="order-management">
              <h3>Quick Access</h3>
              <div class="order-actions">
                <a href="MyOrders.html" class="btn btn-primary">
                  <i class="fas fa-shopping-bag"></i> Manage Orders
                </a>
              </div>
              <p style="text-align: center; color: #6c757d; margin-top: 15px; font-size: 14px;">
                Access all your orders, create new ones, and track deliveries in one place
              </p>
            </div>

            <div class="profile-actions">
              <button class="btn btn-secondary" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> Sign Out
              </button>
            </div>
          `;
      }

      // Inline editing functionality
      let originalValues = {};

      function startEdit(element) {
        const field = element.getAttribute("data-field");
        const currentValue = element.textContent.trim();

        // Store original value
        originalValues[field] = currentValue;

        // Create input field
        let input;
        if (field === "dateOfBirth") {
          input = document.createElement("input");
          input.type = "date";
          input.value = currentValue === "Not provided" ? "" : currentValue;
        } else if (field === "gender") {
          input = document.createElement("select");
          input.innerHTML = `
            <option value="">Select Gender</option>
            <option value="male" ${
              currentValue === "male" ? "selected" : ""
            }>Male</option>
            <option value="female" ${
              currentValue === "female" ? "selected" : ""
            }>Female</option>
            <option value="other" ${
              currentValue === "other" ? "selected" : ""
            }>Other</option>
          `;
        } else {
          input = document.createElement("input");
          input.type = "text";
          input.value = currentValue === "Not provided" ? "" : currentValue;
        }
        input.className = "edit-input";

        // Replace content with input
        element.innerHTML = "";
        element.appendChild(input);
        element.classList.add("editing");

        // Show save/cancel buttons
        const buttons = element.parentElement.querySelector(
          ".save-cancel-buttons"
        );
        buttons.classList.add("show");

        // Focus input
        input.focus();
        input.select();

        // Handle Enter key
        input.addEventListener("keydown", function (e) {
          if (e.key === "Enter") {
            saveField(buttons.querySelector(".btn-success"));
          } else if (e.key === "Escape") {
            cancelEdit(buttons.querySelector(".btn-outline-secondary"));
          }
        });
      }

      async function saveField(button) {
        showLoading("Saving changes...");
        const infoGroup = button.closest(".info-group");
        const valueElement = infoGroup.querySelector(".info-value");
        const input = valueElement.querySelector("input, select");
        const field = valueElement.getAttribute("data-field");
        const newValue = input.value.trim();

        // Validate email
        if (field === "email" && newValue && !isValidEmail(newValue)) {
          alert("Please enter a valid email address");
          return;
        }

        // Show loading state
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
        button.disabled = true;

        try {
          // Get current user data
          const userData = JSON.parse(localStorage.getItem("userData"));
          const sessionToken = localStorage.getItem("sessionToken");

          // Prepare update data
          const updateData = {
            firstName: userData.firstName,
            lastName: userData.lastName,
            email: userData.email,
            phone: userData.phone,
            dateOfBirth: userData.dateOfBirth,
            gender: userData.gender,
            address: userData.address,
            city: userData.city,
            country: userData.country,
          };

          // Update the specific field
          updateData[field] = newValue;

          // Send update to API
          const response = await fetch("/api/profile", {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${sessionToken}`,
            },
            body: JSON.stringify(updateData),
          });

          if (response.ok) {
            const result = await response.json();
            const updatedProfile = result.data;

            // Update localStorage with fresh data
            const updatedUserData = {
              id: updatedProfile.id,
              firstName: updatedProfile.firstName,
              lastName: updatedProfile.lastName,
              email: updatedProfile.email,
              phone: updatedProfile.phone,
              dateOfBirth: updatedProfile.dateOfBirth,
              gender: updatedProfile.gender,
              address: updatedProfile.address,
              city: updatedProfile.city,
              country: updatedProfile.country,
              isVerified: updatedProfile.isVerified,
              emailVerified: updatedProfile.emailVerified,
              phoneVerified: updatedProfile.phoneVerified,
            };

            localStorage.setItem("userData", JSON.stringify(updatedUserData));

            // Update the display
            valueElement.innerHTML = newValue || "Not provided";
            valueElement.classList.remove("editing");

            // Hide save/cancel buttons
            const buttons = infoGroup.querySelector(".save-cancel-buttons");
            buttons.classList.remove("show");

            // Show success message
            showSuccessMessage("Profile updated successfully!");

            // Update profile title if name changed
            if (field === "firstName" || field === "lastName") {
              updateProfileTitle();
            }
          } else {
            const errorResult = await response.json();
            alert(
              "Failed to update profile: " +
                (errorResult.message || "Unknown error")
            );

            // Restore original value
            const originalValue = originalValues[field];
            valueElement.innerHTML = originalValue || "Not provided";
            valueElement.classList.remove("editing");

            // Hide save/cancel buttons
            const buttons = infoGroup.querySelector(".save-cancel-buttons");
            buttons.classList.remove("show");
          }
        } catch (error) {
          console.log("Error updating profile:", error);
          alert("Network error. Please try again.");

          // Restore original value
          const originalValue = originalValues[field];
          valueElement.innerHTML = originalValue || "Not provided";
          valueElement.classList.remove("editing");

          // Hide save/cancel buttons
          const buttons = infoGroup.querySelector(".save-cancel-buttons");
          buttons.classList.remove("show");
        } finally {
          hideLoading();
          // Reset button state
          button.innerHTML = "Save";
          button.disabled = false;
        }
      }

      function cancelEdit(button) {
        const infoGroup = button.closest(".info-group");
        const valueElement = infoGroup.querySelector(".info-value");
        const field = valueElement.getAttribute("data-field");
        const originalValue = originalValues[field];

        // Restore original value
        valueElement.innerHTML = originalValue || "Not provided";
        valueElement.classList.remove("editing");

        // Hide save/cancel buttons
        const buttons = infoGroup.querySelector(".save-cancel-buttons");
        buttons.classList.remove("show");
      }

      function updateProfileTitle() {
        const userData = JSON.parse(localStorage.getItem("userData"));
        const firstName = userData.firstName || "User";
        const lastName = userData.lastName || "";
        const titleElement = document.querySelector(".profile-title");
        if (titleElement) {
          titleElement.textContent = `${firstName} ${lastName}`;
        }
      }

      function showSuccessMessage(message) {
        // Use the same flash message system as login.js
        showFlashMessage(message, "success");
      }

      function showFlashMessage(message, type = "success") {
        // Create flash message container
        const flashDiv = document.createElement("div");
        flashDiv.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          background: ${type === "success" ? "#28a745" : "#dc3545"};
          color: white;
          padding: 16px 24px;
          border-radius: 8px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
          z-index: 10000;
          font-weight: 500;
          font-size: 14px;
          max-width: 350px;
          transform: translateX(100%);
          transition: transform 0.3s ease;
          display: flex;
          align-items: center;
          gap: 12px;
        `;

        // Add icon
        const icon = document.createElement("i");
        icon.className =
          type === "success"
            ? "fas fa-check-circle"
            : "fas fa-exclamation-circle";
        icon.style.fontSize = "18px";

        // Add message text
        const messageText = document.createElement("span");
        messageText.textContent = message;

        flashDiv.appendChild(icon);
        flashDiv.appendChild(messageText);

        // Add to page
        document.body.appendChild(flashDiv);

        // Animate in
        setTimeout(() => {
          flashDiv.style.transform = "translateX(0)";
        }, 100);

        // Auto remove after 3 seconds
        setTimeout(() => {
          flashDiv.style.transform = "translateX(100%)";
          setTimeout(() => {
            if (flashDiv.parentNode) {
              flashDiv.parentNode.removeChild(flashDiv);
            }
          }, 300);
        }, 3000);
      }

      function isValidEmail(email) {
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
      }

      // Handle logout
      function logout() {
        localStorage.removeItem("userData");
        localStorage.removeItem("sessionToken");
        localStorage.removeItem("user_logged_in");
        localStorage.removeItem("cartCount");
        showFlashMessage("You have been signed out successfully.", "success");

        // Redirect to homepage after a short delay
        setTimeout(() => {
          window.location.href = "index.html";
        }, 1500);
      }

      // Check if user is logged in when page loads
      function checkLoginStatus() {
        const isLoggedIn = localStorage.getItem("user_logged_in") === "true";
        const userData = localStorage.getItem("userData");

        if (!isLoggedIn || !userData) {
          showFlashMessage(
            "You need to be logged in to view your profile.",
            "error"
          );

          // Redirect to login page after 2 seconds
          setTimeout(() => {
            window.location.href = "login.html";
          }, 2000);

          return false;
        }
        return true;
      }

      // Admin mode switching functions
      function switchToAdminMode() {
        localStorage.setItem("admin_mode", "true");
        showFlashMessage("Switching to Admin Dashboard...", "success");
        setTimeout(() => {
          window.location.href = "AdminDashboard.html";
        }, 1000);
      }

      function switchToUserMode() {
        localStorage.setItem("admin_mode", "false");
        showFlashMessage("Switched to User Mode", "success");
        // Reload the page to update the UI
        setTimeout(() => {
          window.location.reload();
        }, 1000);
      }

      // Load profile when page loads
      document.addEventListener("DOMContentLoaded", function () {
        if (checkLoginStatus()) {
          loadProfile();
        }
      });
    </script>
  </body>
</html>
